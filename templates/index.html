<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ğŸ¬ Video Summarizer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    #loading {
      display: none;
      color: white;
      font-weight: bold;
      font-size: 1.3em;
    }
    #cancel-alert {
      display: none;
      width: 50%;
      margin: 20px auto;
    }
  </style>
</head>
<body class="bg-gradient text-center py-5">

  <h1 class="mb-4 fw-bold" style="color: black;">ğŸ¥ VidSummify â†’ Video Summarizer</h1>

  <!-- Cancel alert -->
  <div id="cancel-alert" class="alert alert-danger fw-bold" role="alert">
    âŒ Processing canceled by user. Redirecting...
  </div>

  <form id="uploadForm" action="/upload" method="post" enctype="multipart/form-data"
        class="bg-light p-5 rounded shadow-lg d-inline-block">
    <input type="file" name="video" accept=".mp4" class="form-control mb-3" required>
    <button type="submit" class="btn btn-primary btn-lg">Upload & Process ğŸš€</button>
  </form>

  <div id="loading" class="mt-4 text-dark">
    â³ Processing your video... Please wait!
    <div class="spinner-border text-primary mt-3" role="status"></div>
    <div id="progress-text" class="mt-3 fw-bold"></div>

    <!-- Progress Bar -->
    <div class="progress mt-3" style="width: 50%; margin: 0 auto;">
      <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"
           role="progressbar" style="width: 0%">0%</div>
    </div>

    <!-- Cancel Button -->
    <button id="cancelBtn" class="btn btn-danger mt-3">Cancel Processing</button>
  </div>

  <script>
    document.getElementById("uploadForm").addEventListener("submit", function() {
      document.getElementById("loading").style.display = "block";
      const progressText = document.getElementById("progress-text");
      const progressBar = document.getElementById("progress-bar");
      const cancelBtn = document.getElementById("cancelBtn");
      const cancelAlert = document.getElementById("cancel-alert");
      let canceled = false;

      const interval = setInterval(async () => {
        if (canceled) return;

        const response = await fetch("/progress");
        const data = await response.json();

        // Update text
        progressText.textContent = `${data.stage} (${data.percent}%)`;

        // Update bar
        progressBar.style.width = `${data.percent}%`;
        progressBar.textContent = `${data.percent}%`;

        // Color transitions
        if (data.percent < 40) {
          progressBar.className = "progress-bar bg-info progress-bar-striped progress-bar-animated";
        } else if (data.percent < 80) {
          progressBar.className = "progress-bar bg-warning progress-bar-striped progress-bar-animated";
        } else {
          progressBar.className = "progress-bar bg-success progress-bar-striped progress-bar-animated";
        }

        // Stop polling on completion
        if (data.percent >= 100) {
          clearInterval(interval);
          progressText.textContent = "âœ… Completed successfully!";
          progressBar.textContent = "100%";
          progressBar.className = "progress-bar bg-success";
        }
      }, 1000);

      // Cancel processing (frontend + backend)
      cancelBtn.addEventListener("click", async () => {
        canceled = true;
        clearInterval(interval);

        await fetch("/cancel", { method: "POST" });  // tell backend to stop

        progressText.textContent = "âŒ Processing canceled by user.";
        progressBar.className = "progress-bar bg-danger";
        progressBar.style.width = "100%";
        progressBar.textContent = "Canceled";

        // Show cancel alert and redirect after 3 seconds
        cancelAlert.style.display = "block";
        setTimeout(() => {
          window.location.href = "/";
        }, 3000);
      });
    });
  </script>

</body>
</html>
